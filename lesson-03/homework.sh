#!/bin/bash

echo "üîç –ü–æ–∏—Å–∫ –≤ fail2ban IP –∞–¥—Ä–µ—Å–∞ $1 ..."

#—Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞ —Å —è—á–µ–π–∫–æ–π –∏–∑ –º–∞—Å—Å–∏–≤–∞
haveIP () {
  local ip match="$1" #–∑–∞–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
  shift 
  for ip; do [[ "$ip" == "$match" ]] && return 0; done #—Ü–∏–∫–ª —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –≤—ã–≤–æ–¥—è—â–∏–π –µ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
  return 1
}

#–ø–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–∂—ç–π–ª–æ–≤
list=`fail2ban-client status | grep Jail | awk '{ s = ""; for (i = 4; i <= NF; i++) s = s $i " "; print s }'`

#–ø–∏—Ö–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤ –º–∞—Å—Å–∏–≤
IFS=', ' read -r -a jails <<< "$list"

#–ø—Ä–æ—Ö–æ–¥–∏–º—Å—è –ø–æ –¥–∂—ç–π–ª–∞–º
for cell in "${jails[@]}"
    do
        #–¥–æ–±—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ –∞–π–ø–∏ –∞–¥—Ä–µ—Å–æ–≤ –Ω–∞—Ö–æ–¥—è—â–∏—Ö—Å—è –≤ –¥–∂—ç–π–ª–µ
        stringIPs=`fail2ban-client status $cell | grep Banned | awk '{ s = ""; for (i = 5; i <= NF; i++) s = s $i " "; print s }'`
        #–ø–∏—Ö–∞–µ–º –∏—Ö –≤ –º–∞—Å—Å–∏–≤
        IFS=', ' read -r -a arrayIPs <<< "$stringIPs"
        #–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∏—Å–∫–æ–º–æ–≥–æ –∞–¥—Ä–µ—Å–∞ —Å –∞–¥—Ä–µ—Å–∞–º–∏ –≤ –º–∞—Å—Å–∏–≤–µ
        haveIP "$1" "${arrayIPs[@]}"
        #–¥–∞–ª–µ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è —Ä–∞–∑–±–∞–Ω–∏–≤–∞–µ–º, –µ—Å–ª–∏ –Ω–∞–¥–æ
        if [[ 1 -eq $? ]]
            then
                echo "Jail \"$cell\" - –ù–ï –Ω–∞–π–¥–µ–Ω ‚úîÔ∏è "
            else
                echo "Jail \"$cell\" - –ù–ê–ô–î–ï–ù! üëª "
                if whiptail --yesno "–£–±—Ä–∞—Ç—å $1 –∏–∑ '$cell'?" 7 60 ;then
                    echo "$(fail2ban-client set $cell unbanip $1;) –±—ã–ª —Ä–∞–∑–±–∞–Ω–µ–Ω. üôà  "
                else
                    echo "$1 –Ω–µ –±—ã–ª —Ä–∞–∑–±–∞–Ω–µ–Ω. ü§î "
                fi
        fi
done
