# Фильтрация трафика

## [Начало](Vagrantfile "Начало")
Поднимаем четрые ВМ: сервер, центральный роутер и два inetRouter'а (первый для knocking'а, второй для проброса портов)

Провиженим bash-скриптами

## Центральный сервер
На центральном сервере поднимаем nginx и указываем route через центральный роутер
[Скрипт провиженинга](scripts/p_cs.sh)

## Центральный роутер
Устанавливаем nmap для последующего простукивания портов
Удаляем путь по умолчанию
Добавляем путь по умолчанию через inetRouter
[Скрипт провиженинга](scripts/p_cr.sh "Скрипт провиженинга")

## inetRouter - port knocking
Для демонстрации возможности подключения по ssh разрешаем логин по паролю
В iptables создаем цепочки для прохождения port knocking'а
В процессе простукивания перемещаем адрес в списках "шагов"
После простукивания всех нужных портов добавляем адрес в список разрешенных на 60 секунд
[Скрипт провиженинга](scripts/p_ir.sh "Скрипт провиженинга")

## inetRouter2 - NAT без маскарада
С помощью iptables создаем PREROUTING на порт 8080 с порта 80 центрального сервера
Далее делаем POSTROUTING 80'го порта центрального сервера на адрес inetRouter2
[Скрипт провиженинга](scripts/p_ir2.sh "Скрипт провиженинга")

## Проверки
Заходим на центральный роутер
Проверяем проброс портов на inetRouter2: curl 192.168.250.1:8080
Проверяем работает ли port knocking, для этого:
- запускаем из под рута 'bash /vagrant/scripts/knock.sh 192.168.255.1 50910 50920'
- коннектимся 'ssh user1@192.168.255.1', пароль 12345678qaz

[Карта сети](map.txt "Карта сети")
